<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Wardrobe</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#003049">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Wardrobe">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #FDF0D5;
            padding: 20px;
            padding-bottom: 80px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #780000;
            margin-bottom: 20px;
        }
        
        h2 {
            color: #780000;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        h3 {
            color: #003049;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #669BBC;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            color: #003049;
            font-size: 16px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #780000;
            border-bottom-color: #780000;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #FDF0D5;
            border-radius: 8px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            font-family: inherit;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        button {
            background: #003049;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
        }
        
        button:hover {
            background: #669BBC;
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .button-secondary {
            background: #669BBC;
        }
        
        .button-secondary:hover {
            background: #003049;
        }
        
        .button-danger {
            background: #C1121F;
        }
        
        .button-danger:hover {
            background: #780000;
        }
        
        .button-small {
            padding: 6px 12px;
            font-size: 14px;
            width: auto;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .button-group button {
            width: auto;
            flex: 0 0 auto;
        }
        
        .tag-input-container {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            min-height: 42px;
            background: white;
        }
        
        .tag {
            background: #003049;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .tag-remove {
            cursor: pointer;
            font-weight: bold;
        }
        
        .tag-input {
            border: none;
            outline: none;
            flex: 1;
            min-width: 100px;
            padding: 4px;
        }
        
        .item-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .item-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
        }
        
        .item-card.archived {
            opacity: 0.6;
            border-color: #ccc;
        }
        
        .item-card.low-usage {
            border-left: 4px solid #C1121F;
        }
        
        .item-card.not-worn-year {
            border-left: 4px solid #780000;
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .item-name {
            font-weight: 600;
            font-size: 18px;
            color: #333;
            line-height: 1.4;
        }
        
        .item-badge {
            background: #780000;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .item-badge.warning {
            background: #C1121F;
        }
        
        .item-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .item-detail {
            font-size: 14px;
        }
        
        .item-detail-label {
            color: #999;
            font-size: 12px;
        }
        
        .item-detail-value {
            color: #333;
            font-weight: 500;
        }
        
        .item-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 10px;
        }
        
        .item-tag {
            background: #669BBC;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }
        
        .item-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .item-actions button {
            flex: 1 1 auto;
            min-width: 90px;
        }
        
        .filter-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #FDF0D5;
            border-radius: 8px;
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
        
        .empty-state {
            text-align: center;
            color: #999;
            padding: 40px 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #FDF0D5;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #669BBC;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #003049;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .category-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .category-item {
            background: #FDF0D5;
            padding: 15px;
            border-radius: 8px;
        }
        
        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .category-name {
            font-weight: 600;
            font-size: 16px;
        }
        
        .category-stats {
            font-size: 14px;
            color: #666;
        }
        
        .subcategory-list {
            margin-top: 10px;
            padding-left: 15px;
            border-left: 3px solid #669BBC;
        }
        
        .subcategory-item {
            padding: 8px;
            background: white;
            border-radius: 5px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .subcategory-item > div:first-child {
            flex: 1;
            min-width: 150px;
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }
        
        .file-input-label {
            display: block;
            padding: 12px 24px;
            background: #669BBC;
            color: white;
            text-align: center;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .file-input-label:hover {
            background: #003049;
        }
        
        .suggestion-section {
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üëî My Wardrobe</h1>
        
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('wardrobe', this)">Wardrobe</button>
            <button class="tab" onclick="switchTab('add', this)">Add Item</button>
            <button class="tab" onclick="switchTab('suggestions', this)">Archive Suggestions</button>
            <button class="tab" onclick="switchTab('categories', this)">Categories</button>
            <button class="tab" onclick="switchTab('data', this)">Data</button>
        </div>
        
        <!-- Wardrobe Tab -->
        <div id="wardrobeTab" class="tab-content active">
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalItems">0</div>
                    <div class="stat-label">Total Items</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeItems">0</div>
                    <div class="stat-label">Active Items</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="archivedItems">0</div>
                    <div class="stat-label">Archived</div>
                </div>
            </div>
            
            <!-- Filter Section -->
            <div class="filter-section">
                <h3>Search & Filter</h3>
                <div class="filter-grid">
                    <div class="form-group">
                        <label for="searchText">Search</label>
                        <input type="text" id="searchText" placeholder="Search by name, brand, color..." onkeyup="displayItems()">
                    </div>
                    
                    <div class="form-group">
                        <label for="filterCategory">Category</label>
                        <select id="filterCategory" onchange="updateSubcategoryFilter(); displayItems();">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="filterSubcategory">Subcategory</label>
                        <select id="filterSubcategory" onchange="displayItems()">
                            <option value="">All Subcategories</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="filterColor">Color</label>
                        <input type="text" id="filterColor" placeholder="Any color" onkeyup="displayItems()">
                    </div>
                    
                    <div class="form-group">
                        <label for="filterBrand">Brand</label>
                        <input type="text" id="filterBrand" placeholder="Any brand" onkeyup="displayItems()">
                    </div>
                    
                    <div class="form-group">
                        <label for="filterTag">Tag</label>
                        <input type="text" id="filterTag" placeholder="Any tag" onkeyup="displayItems()">
                    </div>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="showArchived" onchange="displayItems()">
                    <label for="showArchived" style="margin: 0;">Show archived items</label>
                </div>
            </div>
            
            <h2>My Items (<span id="itemCount">0</span>)</h2>
            <div class="item-list" id="itemList">
                <!-- Items will appear here -->
            </div>
        </div>
        
        <!-- Add Item Tab -->
        <div id="addTab" class="tab-content">
            <div class="form-section">
                <h2>Add New Item</h2>
                <p style="color: #669BBC; margin-bottom: 15px; font-size: 14px;">
                    üí° The app will check for duplicates and alert you if this item already exists.
                </p>
                <form id="addItemForm">
                    <div class="form-group">
                        <label for="itemName">Item Name *</label>
                        <input type="text" id="itemName" required placeholder="e.g., Blue Denim Jeans">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="category">Category *</label>
                            <select id="category" required onchange="updateSubcategorySelect()">
                                <option value="">Select category</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="subcategoryGroup" style="display: none;">
                            <label for="subcategory">Subcategory</label>
                            <select id="subcategory">
                                <option value="">Select subcategory (optional)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="brand">Brand</label>
                            <input type="text" id="brand" list="brandList" placeholder="e.g., Levi's">
                            <datalist id="brandList"></datalist>
                        </div>
                        
                        <div class="form-group">
                            <label for="color">Color *</label>
                            <input type="text" id="color" list="colorList" required placeholder="e.g., Blue">
                            <datalist id="colorList"></datalist>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="tags">Tags</label>
                        <div class="tag-input-container" id="tagContainer">
                            <input type="text" class="tag-input" id="tagInput" list="tagList" placeholder="Type tag and press Enter">
                            <datalist id="tagList"></datalist>
                        </div>
                        <small style="color: #666;">Press Enter to add tags (e.g., "casual", "summer", "work")</small>
                    </div>
                    
                    <button type="submit" id="addItemButton">Add Item</button>
                </form>
            </div>
        </div>
        
        <!-- Archive Suggestions Tab -->
        <div id="suggestionsTab" class="tab-content">
            <div class="form-section">
                <h2>üìã Items to Consider Archiving</h2>
                <p style="color: #666; margin-bottom: 15px;">
                    These items may be good candidates for archiving based on wear patterns and wardrobe targets.
                </p>
            </div>
            
            <div id="notWornSection" style="margin-bottom: 30px;">
                <h3 style="color: #780000;">üö® Not Worn in 1+ Year (<span id="notWornCount">0</span>)</h3>
                <div class="item-list" id="notWornList"></div>
            </div>
            
            <div id="overTargetSection" style="margin-bottom: 30px;">
                <h3 style="color: #C1121F;">‚ö†Ô∏è Over Target Limits - Summary (<span id="overTargetCount">0</span> items to consider)</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                    Categories and subcategories exceeding their target limits. Click "View Items" to see which specific items to archive.
                </p>
                <div class="item-list" id="overTargetList"></div>
            </div>
            
            <div id="neverWornSection">
                <h3 style="color: #669BBC;">üí§ Never Worn (Added 6+ Months Ago) (<span id="neverWornCount">0</span>)</h3>
                <div class="item-list" id="neverWornList"></div>
            </div>
        </div>
        
        <!-- Categories Tab -->
        <div id="categoriesTab" class="tab-content">
            <div class="form-section">
                <h2>Add New Category</h2>
                <form id="addCategoryForm">
                    <div class="form-group">
                        <label for="categoryName">Category Name *</label>
                        <input type="text" id="categoryName" required placeholder="e.g., Tops">
                    </div>
                    
                    <div class="form-group">
                        <label for="categoryTarget">Target for Entire Category (Optional)</label>
                        <input type="number" id="categoryTarget" min="0" placeholder="e.g., 20">
                    </div>
                    
                    <button type="submit">Add Category</button>
                </form>
            </div>
            
            <h2>My Categories</h2>
            <p style="color: #669BBC; margin-bottom: 15px; font-size: 14px;">
                üí° Add emojis to subcategories to make items easier to identify in your wardrobe!
            </p>
            <div class="category-list" id="categoryList"></div>
        </div>
        
        <!-- Data Tab -->
        <div id="dataTab" class="tab-content">
            <div class="form-section">
                <h2>Export Data</h2>
                <p style="margin-bottom: 15px; color: #666;">Download your wardrobe data as a CSV file for backup or use in Excel/Google Sheets.</p>
                <button onclick="exportData()">üì• Export to CSV</button>
            </div>
            
            <div class="form-section">
                <h2>Import Data</h2>
                <p style="margin-bottom: 15px; color: #666;">Import items from a CSV file. Data will be added to your existing items.</p>
                <div class="file-input-wrapper">
                    <input type="file" id="importFile" accept=".csv" onchange="importData()">
                    <label for="importFile" class="file-input-label">üì§ Choose CSV File to Import</label>
                </div>
                <small style="display: block; margin-top: 10px; color: #666;">
                    Expected format: Name, Category, Subcategory, Brand, Color, Tags (semicolon-separated)<br>
                    Example: Blue Jeans, Bottoms, Denim, Levi's, Blue, casual;summer
                </small>
            </div>
            
            <div class="form-section">
                <h2>‚ö†Ô∏è Danger Zone</h2>
                <p style="margin-bottom: 15px; color: #666;">Clear all data from the app. This cannot be undone!</p>
                <button class="button-danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
            </div>
        </div>
    </div>

    <script>
        // Storage keys
        const ITEMS_KEY = 'wardrobeItems';
        const CATEGORIES_KEY = 'wardrobeCategories';
        
        // Current tags being added
        let currentTags = [];
        
        // Load items from storage
        function loadItems() {
            const stored = localStorage.getItem(ITEMS_KEY);
            return stored ? JSON.parse(stored) : [];
        }
        
        // Save items to storage
        function saveItems(items) {
            try {
                localStorage.setItem(ITEMS_KEY, JSON.stringify(items));
                return true;
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                alert('Error saving data. Storage may be full.');
                return false;
            }
        }
        
        // Load categories from storage
        function loadCategories() {
            const stored = localStorage.getItem(CATEGORIES_KEY);
            if (stored) {
                return JSON.parse(stored);
            }
            return [
                { name: 'Tops', target: null, subcategories: [] },
                { name: 'Bottoms', target: null, subcategories: [] },
                { name: 'Dresses', target: null, subcategories: [] },
                { name: 'Outerwear', target: null, subcategories: [] },
                { name: 'Shoes', target: null, subcategories: [] },
                { name: 'Accessories', target: null, subcategories: [] }
            ];
        }
        
        // Save categories to storage
        function saveCategories(categories) {
            try {
                localStorage.setItem(CATEGORIES_KEY, JSON.stringify(categories));
                return true;
            } catch (error) {
                console.error('Error saving categories:', error);
                return false;
            }
        }
        
        // Switch between tabs
        function switchTab(tabName, clickedElement) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            if (clickedElement) {
                clickedElement.classList.add('active');
            } else {
                document.querySelectorAll('.tab').forEach(tab => {
                    if (tab.textContent.toLowerCase().includes(tabName)) {
                        tab.classList.add('active');
                    }
                });
            }
            
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            if (tabName === 'wardrobe') {
                displayItems();
                updateCategoryFilter();
                updateSubcategoryFilter();
                updateStats();
            } else if (tabName === 'categories') {
                displayCategories();
            } else if (tabName === 'add') {
                updateCategorySelect();
                populateDataLists();
            } else if (tabName === 'suggestions') {
                displayArchiveSuggestions();
            }
        }
        
        // Normalize string for comparison (remove case, spacing, symbols)
        function normalizeString(str) {
            if (!str) return '';
            return str.toLowerCase()
                .replace(/[^a-z0-9]/g, '') // Remove all non-alphanumeric characters
                .trim();
        }
        
        // Check if item already exists
        function checkDuplicateItem(name, brand, color, category, subcategory) {
            const items = loadItems();
            const normalizedNew = {
                name: normalizeString(name),
                brand: normalizeString(brand),
                color: normalizeString(color),
                category: normalizeString(category),
                subcategory: normalizeString(subcategory)
            };
            
            const duplicate = items.find(item => {
                const normalizedExisting = {
                    name: normalizeString(item.name),
                    brand: normalizeString(item.brand),
                    color: normalizeString(item.color),
                    category: normalizeString(item.category),
                    subcategory: normalizeString(item.subcategory)
                };
                
                return normalizedExisting.name === normalizedNew.name &&
                       normalizedExisting.brand === normalizedNew.brand &&
                       normalizedExisting.color === normalizedNew.color &&
                       normalizedExisting.category === normalizedNew.category &&
                       normalizedExisting.subcategory === normalizedNew.subcategory;
            });
            
            return duplicate;
        }
        
        // Update stats
        function updateStats() {
            const items = loadItems();
            const active = items.filter(i => !i.archived).length;
            const archived = items.filter(i => i.archived).length;
            
            document.getElementById('totalItems').textContent = items.length;
            document.getElementById('activeItems').textContent = active;
            document.getElementById('archivedItems').textContent = archived;
        }
        
        // Update category select
        function updateCategorySelect() {
            const categories = loadCategories();
            const select = document.getElementById('category');
            select.innerHTML = '<option value="">Select category</option>' + 
                categories.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('');
        }
        
        // Update subcategory select
        function updateSubcategorySelect() {
            const categoryName = document.getElementById('category').value;
            const categories = loadCategories();
            const category = categories.find(c => c.name === categoryName);
            
            const subcategoryGroup = document.getElementById('subcategoryGroup');
            const subcategorySelect = document.getElementById('subcategory');
            
            if (category && category.subcategories && category.subcategories.length > 0) {
                subcategoryGroup.style.display = 'block';
                subcategorySelect.innerHTML = '<option value="">Select subcategory (optional)</option>' +
                    category.subcategories.map(sub => `<option value="${sub.name}">${sub.name}</option>`).join('');
            } else {
                subcategoryGroup.style.display = 'none';
            }
        }
        
        // Update category filter
        function updateCategoryFilter() {
            const categories = loadCategories();
            const select = document.getElementById('filterCategory');
            const currentValue = select.value;
            select.innerHTML = '<option value="">All Categories</option>' + 
                categories.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('');
            select.value = currentValue;
        }
        
        // Update subcategory filter based on selected category
        function updateSubcategoryFilter() {
            const categoryName = document.getElementById('filterCategory').value;
            const categories = loadCategories();
            const select = document.getElementById('filterSubcategory');
            
            if (!categoryName) {
                select.innerHTML = '<option value="">All Subcategories</option>';
                return;
            }
            
            const category = categories.find(c => c.name === categoryName);
            
            if (category && category.subcategories && category.subcategories.length > 0) {
                // Sort subcategories alphabetically
                const sortedSubcategories = [...category.subcategories].sort((a, b) => a.name.localeCompare(b.name));
                
                select.innerHTML = '<option value="">All Subcategories</option>' +
                    sortedSubcategories.map(sub => `<option value="${sub.name}">${sub.emoji ? sub.emoji + ' ' : ''}${sub.name}</option>`).join('');
            } else {
                select.innerHTML = '<option value="">All Subcategories</option>';
            }
        }
        
        // Populate datalists with previous values
        function populateDataLists() {
            const items = loadItems();
            
            // Get unique brands
            const brands = [...new Set(items.map(item => item.brand).filter(b => b))].sort();
            const brandList = document.getElementById('brandList');
            if (brandList) {
                brandList.innerHTML = brands.map(b => `<option value="${b}">`).join('');
            }
            
            // Get unique colors
            const colors = [...new Set(items.map(item => item.color).filter(c => c))].sort();
            const colorList = document.getElementById('colorList');
            if (colorList) {
                colorList.innerHTML = colors.map(c => `<option value="${c}">`).join('');
            }
            
            // Get unique tags (flatten all tags from all items)
            const allTags = items.reduce((tags, item) => {
                if (item.tags) {
                    return [...tags, ...item.tags];
                }
                return tags;
            }, []);
            const uniqueTags = [...new Set(allTags)].sort();
            
            // Store for tag input
            window.availableTags = uniqueTags;
        }
        
        // Get items not worn in over a year
        function getItemsNotWornInYear() {
            const items = loadItems();
            const notWornSet = new Set();
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            
            items.forEach((item, index) => {
                if (item.archived) return;
                
                if (!item.wearHistory || item.wearHistory.length === 0) {
                    const dateAdded = new Date(item.dateAdded);
                    if (dateAdded < oneYearAgo) {
                        notWornSet.add(index);
                    }
                } else {
                    const lastWornDate = new Date(item.wearHistory[item.wearHistory.length - 1]);
                    if (lastWornDate < oneYearAgo) {
                        notWornSet.add(index);
                    }
                }
            });
            
            return notWornSet;
        }
        
        // Get last worn info
        function getLastWornInfo(item) {
            if (!item.wearHistory || item.wearHistory.length === 0) {
                return { text: 'Never worn', isWarning: false };
            }
            
            const lastWornDate = new Date(item.wearHistory[item.wearHistory.length - 1]);
            const today = new Date();
            const daysSince = Math.floor((today - lastWornDate) / (1000 * 60 * 60 * 24));
            
            let text;
            let isWarning = false;
            
            if (daysSince === 0) {
                text = 'Worn today';
            } else if (daysSince === 1) {
                text = 'Worn yesterday';
            } else if (daysSince < 7) {
                text = `Worn ${daysSince} days ago`;
            } else if (daysSince < 30) {
                const weeks = Math.floor(daysSince / 7);
                text = `Worn ${weeks} week${weeks > 1 ? 's' : ''} ago`;
            } else if (daysSince < 365) {
                const months = Math.floor(daysSince / 30);
                text = `Worn ${months} month${months > 1 ? 's' : ''} ago`;
            } else {
                const years = Math.floor(daysSince / 365);
                text = `Worn ${years} year${years > 1 ? 's' : ''} ago`;
                isWarning = true;
            }
            
            return { text, isWarning };
        }
        
        // Get items to highlight (over target)
        function getItemsToHighlight() {
            const items = loadItems();
            const categories = loadCategories();
            const highlighted = new Set();
            
            categories.forEach(category => {
                if (category.target) {
                    const categoryItems = items
                        .map((item, index) => ({ ...item, originalIndex: index }))
                        .filter(item => item.category === category.name && !item.archived);
                    
                    if (categoryItems.length > category.target) {
                        categoryItems.sort((a, b) => (a.wearCount || 0) - (b.wearCount || 0));
                        const excess = categoryItems.length - category.target;
                        for (let i = 0; i < excess; i++) {
                            highlighted.add(categoryItems[i].originalIndex);
                        }
                    }
                }
                
                if (category.subcategories) {
                    category.subcategories.forEach(subcategory => {
                        if (subcategory.target) {
                            const subcategoryItems = items
                                .map((item, index) => ({ ...item, originalIndex: index }))
                                .filter(item => 
                                    item.category === category.name && 
                                    item.subcategory === subcategory.name && 
                                    !item.archived
                                );
                            
                            if (subcategoryItems.length > subcategory.target) {
                                subcategoryItems.sort((a, b) => (a.wearCount || 0) - (b.wearCount || 0));
                                const excess = subcategoryItems.length - subcategory.target;
                                for (let i = 0; i < excess; i++) {
                                    highlighted.add(subcategoryItems[i].originalIndex);
                                }
                            }
                        }
                    });
                }
            });
            
            return highlighted;
        }
        
        // Get emoji for item based on subcategory
        function getItemEmoji(item) {
            if (!item.subcategory) return '';
            
            const categories = loadCategories();
            const category = categories.find(cat => cat.name === item.category);
            
            if (!category || !category.subcategories) return '';
            
            const subcategory = category.subcategories.find(sub => sub.name === item.subcategory);
            
            return subcategory && subcategory.emoji ? subcategory.emoji + ' ' : '';
        }
        
        // Display all items
        function displayItems() {
            const items = loadItems();
            const list = document.getElementById('itemList');
            const searchText = document.getElementById('searchText').value.toLowerCase();
            const filterCategory = document.getElementById('filterCategory').value;
            const filterSubcategory = document.getElementById('filterSubcategory').value;
            const filterColor = document.getElementById('filterColor').value.toLowerCase();
            const filterBrand = document.getElementById('filterBrand').value.toLowerCase();
            const filterTag = document.getElementById('filterTag').value.toLowerCase();
            const showArchived = document.getElementById('showArchived').checked;
            const highlighted = getItemsToHighlight();
            const notWornInYear = getItemsNotWornInYear();
            
            let filteredItems = items.map((item, index) => ({ ...item, originalIndex: index }));
            
            // Apply filters
            if (searchText) {
                filteredItems = filteredItems.filter(item => 
                    item.name.toLowerCase().includes(searchText) ||
                    (item.brand && item.brand.toLowerCase().includes(searchText)) ||
                    (item.color && item.color.toLowerCase().includes(searchText))
                );
            }
            
            if (filterCategory) {
                filteredItems = filteredItems.filter(item => item.category === filterCategory);
            }
            
            if (filterSubcategory) {
                filteredItems = filteredItems.filter(item => item.subcategory === filterSubcategory);
            }
            
            if (filterColor) {
                filteredItems = filteredItems.filter(item => 
                    item.color && item.color.toLowerCase().includes(filterColor)
                );
            }
            
            if (filterBrand) {
                filteredItems = filteredItems.filter(item => 
                    item.brand && item.brand.toLowerCase().includes(filterBrand)
                );
            }
            
            if (filterTag) {
                filteredItems = filteredItems.filter(item => 
                    item.tags && item.tags.some(tag => tag.toLowerCase().includes(filterTag))
                );
            }
            
            if (!showArchived) {
                filteredItems = filteredItems.filter(item => !item.archived);
            }
            
            // Sort by: Category > Subcategory > Frequency (wear count descending)
            filteredItems.sort((a, b) => {
                // First by category
                if (a.category !== b.category) {
                    return a.category.localeCompare(b.category);
                }
                // Then by subcategory
                const aSubcat = a.subcategory || '';
                const bSubcat = b.subcategory || '';
                if (aSubcat !== bSubcat) {
                    return aSubcat.localeCompare(bSubcat);
                }
                // Then by frequency (descending - most worn first)
                return (b.wearCount || 0) - (a.wearCount || 0);
            });
            
            document.getElementById('itemCount').textContent = filteredItems.length;
            
            if (filteredItems.length === 0) {
                list.innerHTML = '<div class="empty-state">No items found. Try adjusting your filters.</div>';
                return;
            }
            
            list.innerHTML = filteredItems.map((item) => {
                const isHighlighted = highlighted.has(item.originalIndex);
                const notWornYear = notWornInYear.has(item.originalIndex);
                const lastWornInfo = getLastWornInfo(item);
                const cardClass = notWornYear ? 'not-worn-year' : (isHighlighted ? 'low-usage' : '');
                const emoji = getItemEmoji(item);
                
                return `
                <div class="item-card ${cardClass} ${item.archived ? 'archived' : ''}">
                    <div class="item-header">
                        <div class="item-name">${emoji}${item.name}</div>
                        ${notWornYear && !item.archived ? '<span class="item-badge">Not worn 1+ year</span>' : ''}
                        ${isHighlighted && !notWornYear && !item.archived ? '<span class="item-badge warning">Over target</span>' : ''}
                        ${item.archived ? '<span class="item-badge" style="background: #669BBC;">Archived</span>' : ''}
                    </div>
                    
                    <div class="item-details">
                        <div class="item-detail">
                            <div class="item-detail-label">Category</div>
                            <div class="item-detail-value">${item.category}${item.subcategory ? ' > ' + item.subcategory : ''}</div>
                        </div>
                        ${item.brand ? `
                        <div class="item-detail">
                            <div class="item-detail-label">Brand</div>
                            <div class="item-detail-value">${item.brand}</div>
                        </div>
                        ` : ''}
                        <div class="item-detail">
                            <div class="item-detail-label">Color</div>
                            <div class="item-detail-value">${item.color}</div>
                        </div>
                        <div class="item-detail">
                            <div class="item-detail-label">Worn</div>
                            <div class="item-detail-value">${item.wearCount || 0} times</div>
                        </div>
                        <div class="item-detail">
                            <div class="item-detail-label">Last Worn</div>
                            <div class="item-detail-value" style="color: ${lastWornInfo.isWarning ? '#780000' : '#333'}">${lastWornInfo.text}</div>
                        </div>
                    </div>
                    
                    ${item.tags && item.tags.length > 0 ? `
                        <div class="item-tags">
                            ${item.tags.map(tag => `<span class="item-tag">${tag}</span>`).join('')}
                        </div>
                    ` : ''}
                    
                    <div class="item-actions">
                        ${!item.archived ? `<button class="button-small" style="background: #669BBC;" onclick="logWear(${item.originalIndex})">Wore Today</button>` : ''}
                        <button class="button-small" style="background: #003049;" onclick="editItem(${item.originalIndex})">Edit</button>
                        ${!item.archived ? `<button class="button-secondary button-small" onclick="archiveItem(${item.originalIndex})">Archive</button>` : ''}
                        ${item.archived ? `<button class="button-small" onclick="unarchiveItem(${item.originalIndex})">Unarchive</button>` : ''}
                        <button class="button-danger button-small" onclick="deleteItem(${item.originalIndex})">Delete</button>
                    </div>
                </div>
            `}).join('');
        }
        
        // Display archive suggestions
        function displayArchiveSuggestions() {
            const items = loadItems();
            const notWornInYear = getItemsNotWornInYear();
            const highlighted = getItemsToHighlight();
            const categories = loadCategories();
            
            // Items not worn in 1+ year
            const notWornItems = items
                .map((item, index) => ({ ...item, originalIndex: index }))
                .filter(item => !item.archived && notWornInYear.has(item.originalIndex));
            
            // Get over-target summary by category/subcategory
            const overTargetSummary = [];
            
            categories.forEach(category => {
                const categoryItems = items.filter(item => item.category === category.name && !item.archived);
                
                // Check category-level target
                if (category.target && categoryItems.length > category.target) {
                    const excess = categoryItems.length - category.target;
                    overTargetSummary.push({
                        category: category.name,
                        subcategory: null,
                        target: category.target,
                        current: categoryItems.length,
                        excess: excess,
                        type: 'category'
                    });
                }
                
                // Check subcategory-level targets
                if (category.subcategories) {
                    category.subcategories.forEach(subcategory => {
                        if (subcategory.target) {
                            const subcategoryItems = categoryItems.filter(item => item.subcategory === subcategory.name);
                            
                            if (subcategoryItems.length > subcategory.target) {
                                const excess = subcategoryItems.length - subcategory.target;
                                overTargetSummary.push({
                                    category: category.name,
                                    subcategory: subcategory.name,
                                    emoji: subcategory.emoji,
                                    target: subcategory.target,
                                    current: subcategoryItems.length,
                                    excess: excess,
                                    type: 'subcategory'
                                });
                            }
                        }
                    });
                }
            });
            
            // Never worn items added 6+ months ago
            const sixMonthsAgo = new Date();
            sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
            
            const neverWornItems = items
                .map((item, index) => ({ ...item, originalIndex: index }))
                .filter(item => {
                    if (item.archived) return false;
                    if (item.wearHistory && item.wearHistory.length > 0) return false;
                    const dateAdded = new Date(item.dateAdded);
                    return dateAdded < sixMonthsAgo;
                });
            
            // Update counts
            document.getElementById('notWornCount').textContent = notWornItems.length;
            document.getElementById('overTargetCount').textContent = overTargetSummary.reduce((sum, item) => sum + item.excess, 0);
            document.getElementById('neverWornCount').textContent = neverWornItems.length;
            
            // Display not worn items
            displaySuggestionList(notWornItems, 'notWornList');
            
            // Display over target summary
            displayOverTargetSummary(overTargetSummary);
            
            // Display never worn items
            displaySuggestionList(neverWornItems, 'neverWornList');
        }
        
        // Display over target summary
        function displayOverTargetSummary(summary) {
            const list = document.getElementById('overTargetList');
            
            if (summary.length === 0) {
                list.innerHTML = '<div class="empty-state" style="padding: 20px;">All categories within target limits! üéâ</div>';
                return;
            }
            
            list.innerHTML = summary.map((item) => {
                const displayName = item.type === 'subcategory' 
                    ? `${item.emoji ? item.emoji + ' ' : ''}${item.subcategory}`
                    : item.category;
                
                const fullPath = item.type === 'subcategory'
                    ? `${item.category} > ${item.subcategory}`
                    : item.category;
                
                return `
                <div class="item-card" style="border-left: 4px solid #C1121F;">
                    <div class="item-header">
                        <div class="item-name">${displayName}</div>
                        <span class="item-badge warning">${item.excess} over target</span>
                    </div>
                    
                    <div class="item-details">
                        <div class="item-detail">
                            <div class="item-detail-label">Path</div>
                            <div class="item-detail-value">${fullPath}</div>
                        </div>
                        <div class="item-detail">
                            <div class="item-detail-label">Current Items</div>
                            <div class="item-detail-value">${item.current}</div>
                        </div>
                        <div class="item-detail">
                            <div class="item-detail-label">Target</div>
                            <div class="item-detail-value">${item.target}</div>
                        </div>
                        <div class="item-detail">
                            <div class="item-detail-label">Need to Remove</div>
                            <div class="item-detail-value" style="color: #C1121F; font-weight: 600;">${item.excess} items</div>
                        </div>
                    </div>
                    
                    <div class="item-actions">
                        <button class="button-small" onclick="viewCategoryItems('${item.category}', ${item.subcategory ? `'${item.subcategory}'` : 'null'})">View Items</button>
                    </div>
                </div>
            `}).join('');
        }
        
        // View items in a specific category/subcategory
        function viewCategoryItems(category, subcategory) {
            switchTab('wardrobe');
            
            // Set filters
            document.getElementById('filterCategory').value = category;
            updateSubcategoryFilter();
            
            if (subcategory) {
                document.getElementById('filterSubcategory').value = subcategory;
            }
            
            // Clear other filters
            document.getElementById('searchText').value = '';
            document.getElementById('filterColor').value = '';
            document.getElementById('filterBrand').value = '';
            document.getElementById('filterTag').value = '';
            document.getElementById('showArchived').checked = false;
            
            displayItems();
        }
        
        // Display suggestion list helper
        function displaySuggestionList(items, listId) {
            const list = document.getElementById(listId);
            
            if (items.length === 0) {
                list.innerHTML = '<div class="empty-state" style="padding: 20px;">No items in this category! üéâ</div>';
                return;
            }
            
            list.innerHTML = items.map((item) => {
                const lastWornInfo = getLastWornInfo(item);
                const emoji = getItemEmoji(item);
                
                return `
                <div class="item-card">
                    <div class="item-header">
                        <div class="item-name">${emoji}${item.name}</div>
                    </div>
                    
                    <div class="item-details">
                        <div class="item-detail">
                            <div class="item-detail-label">Category</div>
                            <div class="item-detail-value">${item.category}${item.subcategory ? ' > ' + item.subcategory : ''}</div>
                        </div>
                        ${item.brand ? `
                        <div class="item-detail">
                            <div class="item-detail-label">Brand</div>
                            <div class="item-detail-value">${item.brand}</div>
                        </div>
                        ` : ''}
                        <div class="item-detail">
                            <div class="item-detail-label">Color</div>
                            <div class="item-detail-value">${item.color}</div>
                        </div>
                        <div class="item-detail">
                            <div class="item-detail-label">Worn</div>
                            <div class="item-detail-value">${item.wearCount || 0} times</div>
                        </div>
                        <div class="item-detail">
                            <div class="item-detail-label">Last Worn</div>
                            <div class="item-detail-value" style="color: ${lastWornInfo.isWarning ? '#780000' : '#333'}">${lastWornInfo.text}</div>
                        </div>
                    </div>
                    
                    ${item.tags && item.tags.length > 0 ? `
                        <div class="item-tags">
                            ${item.tags.map(tag => `<span class="item-tag">${tag}</span>`).join('')}
                        </div>
                    ` : ''}
                    
                    <div class="item-actions">
                        <button class="button-small" style="background: #003049;" onclick="editItem(${item.originalIndex}); displayArchiveSuggestions();">Edit</button>
                        <button class="button-secondary button-small" onclick="archiveItem(${item.originalIndex}); displayArchiveSuggestions();">Archive</button>
                        <button class="button-danger button-small" onclick="deleteItem(${item.originalIndex}); displayArchiveSuggestions();">Delete</button>
                    </div>
                </div>
            `}).join('');
        }
        function archiveItem(index) {
            const items = loadItems();
            items[index].archived = true;
            saveItems(items);
            displayItems();
            updateStats();
        }
        
        // Unarchive item
        function unarchiveItem(index) {
            const items = loadItems();
            items[index].archived = false;
            saveItems(items);
            displayItems();
            updateStats();
        }
        
        // Delete item
        function deleteItem(index) {
            const items = loadItems();
            if (!confirm(`Delete "${items[index].name}"? This cannot be undone.`)) {
                return;
            }
            items.splice(index, 1);
            saveItems(items);
            displayItems();
            updateStats();
        }
        
        // Log wear
        function logWear(index) {
            const items = loadItems();
            const today = new Date().toISOString().split('T')[0];
            
            if (!items[index].wearHistory) {
                items[index].wearHistory = [];
            }
            
            items[index].wearHistory.push(today);
            items[index].wearCount = items[index].wearHistory.length;
            
            saveItems(items);
            displayItems();
        }
        
        // Tag input handling
        function setupTagInput() {
            const tagInput = document.getElementById('tagInput');
            if (!tagInput) return;
            
            const newTagInput = tagInput.cloneNode(true);
            tagInput.parentNode.replaceChild(newTagInput, tagInput);
            
            newTagInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const tag = this.value.trim();
                    if (tag && !currentTags.includes(tag)) {
                        currentTags.push(tag);
                        updateTagDisplay();
                        this.value = '';
                    }
                }
            });
        }
        
        function updateTagDisplay() {
            const container = document.getElementById('tagContainer');
            const tagsHTML = currentTags.map((tag, index) => `
                <span class="tag">
                    ${tag}
                    <span class="tag-remove" onclick="removeTag(${index})">√ó</span>
                </span>
            `).join('');
            
            container.innerHTML = tagsHTML + '<input type="text" class="tag-input" id="tagInput" list="tagList" placeholder="Type tag and press Enter"><datalist id="tagList"></datalist>';
            
            // Populate tag list
            if (window.availableTags) {
                const tagList = document.getElementById('tagList');
                tagList.innerHTML = window.availableTags.map(t => `<option value="${t}">`).join('');
            }
            
            setupTagInput();
        }
        
        function removeTag(index) {
            currentTags.splice(index, 1);
            updateTagDisplay();
        }
        
        // Add item form
        document.getElementById('addItemForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitButton = document.getElementById('addItemButton');
            submitButton.disabled = true;
            submitButton.textContent = 'Adding...';
            
            const name = document.getElementById('itemName').value.trim();
            const category = document.getElementById('category').value;
            const subcategory = document.getElementById('subcategory').value;
            const brand = document.getElementById('brand').value.trim();
            const color = document.getElementById('color').value.trim();
            
            // Check for duplicate
            const duplicate = checkDuplicateItem(name, brand, color, category, subcategory);
            
            if (duplicate) {
                submitButton.disabled = false;
                submitButton.textContent = 'Add Item';
                
                const duplicateDetails = `
Name: ${duplicate.name}
Brand: ${duplicate.brand || 'N/A'}
Color: ${duplicate.color}
Category: ${duplicate.category}${duplicate.subcategory ? ' > ' + duplicate.subcategory : ''}
Status: ${duplicate.archived ? 'Archived' : 'Active'}
Worn: ${duplicate.wearCount || 0} times
                `.trim();
                
                const message = `‚ö†Ô∏è This item already exists in your wardrobe!

${duplicateDetails}

What would you like to do?
‚Ä¢ Click OK to view this item in your wardrobe
‚Ä¢ Click Cancel to rename/modify the new item

Tip: If you have multiple similar items, try adding details to the name like "Blue Jeans (Light Wash)" or "Blue Jeans (Skinny Fit)"`;
                
                if (confirm(message)) {
                    // Switch to wardrobe and highlight the duplicate
                    switchTab('wardrobe');
                    
                    // Set filters to show the duplicate
                    document.getElementById('filterCategory').value = duplicate.category;
                    updateSubcategoryFilter();
                    if (duplicate.subcategory) {
                        document.getElementById('filterSubcategory').value = duplicate.subcategory;
                    }
                    document.getElementById('searchText').value = duplicate.name;
                    displayItems();
                }
                
                return;
            }
            
            const newItem = {
                name: name,
                category: category,
                subcategory: subcategory || null,
                brand: brand || null,
                color: color,
                tags: [...currentTags],
                dateAdded: new Date().toISOString(),
                wearCount: 0,
                wearHistory: [],
                archived: false
            };
            
            const items = loadItems();
            items.push(newItem);
            
            if (saveItems(items)) {
                document.getElementById('addItemForm').reset();
                currentTags = [];
                const tagContainer = document.getElementById('tagContainer');
                tagContainer.innerHTML = '<input type="text" class="tag-input" id="tagInput" list="tagList" placeholder="Type tag and press Enter"><datalist id="tagList"></datalist>';
                
                // Repopulate datalists with new values
                populateDataLists();
                
                // Update tag datalist
                if (window.availableTags) {
                    const tagList = document.getElementById('tagList');
                    tagList.innerHTML = window.availableTags.map(t => `<option value="${t}">`).join('');
                }
                
                setupTagInput();
                document.getElementById('subcategoryGroup').style.display = 'none';
                
                alert('Item added successfully!');
                setTimeout(() => switchTab('wardrobe'), 100);
            }
            
            submitButton.disabled = false;
            submitButton.textContent = 'Add Item';
        });
        
        // Add category form
        document.getElementById('addCategoryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('categoryName').value.trim();
            const target = document.getElementById('categoryTarget').value;
            
            const categories = loadCategories();
            
            if (categories.some(cat => cat.name.toLowerCase() === name.toLowerCase())) {
                alert('A category with this name already exists!');
                return;
            }
            
            categories.push({
                name: name,
                target: target ? parseInt(target) : null,
                subcategories: []
            });
            
            saveCategories(categories);
            displayCategories();
            updateCategorySelect();
            updateCategoryFilter();
            
            document.getElementById('addCategoryForm').reset();
            alert('Category added successfully!');
        });
        
        // Display categories
        function displayCategories() {
            const categories = loadCategories();
            const items = loadItems();
            const list = document.getElementById('categoryList');
            
            if (categories.length === 0) {
                list.innerHTML = '<div class="empty-state">No categories yet.</div>';
                return;
            }
            
            list.innerHTML = categories.map((category, index) => {
                const categoryItems = items.filter(item => item.category === category.name && !item.archived);
                const itemCount = categoryItems.length;
                const isOverTarget = category.target && itemCount > category.target;
                
                // Sort subcategories alphabetically
                const sortedSubcategories = category.subcategories 
                    ? [...category.subcategories].sort((a, b) => a.name.localeCompare(b.name))
                    : [];
                
                return `
                <div class="category-item">
                    <div class="category-header">
                        <div>
                            <div class="category-name">${category.name}</div>
                            <div class="category-stats">
                                ${itemCount} items
                                ${category.target ? ` | Target: ${category.target}` : ''}
                                ${isOverTarget ? ` (${itemCount - category.target} over)` : ''}
                            </div>
                        </div>
                        <div class="button-group">
                            <button class="button-small" style="background: #669BBC;" onclick="editCategory(${index})">Edit</button>
                            <button class="button-secondary button-small" onclick="addSubcategoryPrompt(${index})">+ Subcategory</button>
                            <button class="button-danger button-small" onclick="deleteCategory(${index})">Delete</button>
                        </div>
                    </div>
                    
                    ${sortedSubcategories.length > 0 ? `
                        <div class="subcategory-list">
                            ${sortedSubcategories.map((sub) => {
                                const originalIndex = category.subcategories.findIndex(s => s.name === sub.name);
                                const subItems = categoryItems.filter(item => item.subcategory === sub.name);
                                const subCount = subItems.length;
                                const subOverTarget = sub.target && subCount > sub.target;
                                
                                return `
                                <div class="subcategory-item">
                                    <div>
                                        <div style="font-weight: 500;">${sub.emoji ? sub.emoji + ' ' : ''}${sub.name}</div>
                                        <div style="font-size: 12px; color: #666;">
                                            ${subCount} items
                                            ${sub.target ? ` | Target: ${sub.target}` : ''}
                                            ${subOverTarget ? ` (${subCount - sub.target} over)` : ''}
                                        </div>
                                    </div>
                                    <div class="button-group">
                                        <button class="button-small" style="background: #669BBC;" onclick="editSubcategory(${index}, ${originalIndex})">Edit</button>
                                        <button class="button-danger button-small" onclick="deleteSubcategory(${index}, ${originalIndex})">Delete</button>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    ` : ''}
                </div>
            `}).join('');
        }
        
        // Edit category
        function editCategory(categoryIndex) {
            const categories = loadCategories();
            const category = categories[categoryIndex];
            
            const newName = prompt('Edit category name:', category.name);
            if (newName === null) return; // User cancelled
            
            const trimmedName = newName.trim();
            if (!trimmedName) {
                alert('Category name cannot be empty!');
                return;
            }
            
            // Check if new name already exists (excluding current category)
            if (categories.some((cat, idx) => idx !== categoryIndex && cat.name.toLowerCase() === trimmedName.toLowerCase())) {
                alert('A category with this name already exists!');
                return;
            }
            
            const oldName = category.name;
            
            // Update category name
            categories[categoryIndex].name = trimmedName;
            
            // Update target
            const targetInput = prompt('Edit target number (leave empty for no target):', category.target || '');
            if (targetInput !== null) {
                categories[categoryIndex].target = targetInput.trim() ? parseInt(targetInput) : null;
            }
            
            // Update all items that use this category
            const items = loadItems();
            items.forEach(item => {
                if (item.category === oldName) {
                    item.category = trimmedName;
                }
            });
            
            saveCategories(categories);
            saveItems(items);
            displayCategories();
            updateCategorySelect();
            updateCategoryFilter();
            
            alert('Category updated successfully!');
        }
        
        // Edit subcategory
        function editSubcategory(categoryIndex, subcategoryIndex) {
            const categories = loadCategories();
            const subcategory = categories[categoryIndex].subcategories[subcategoryIndex];
            const categoryName = categories[categoryIndex].name;
            
            const newName = prompt('Edit subcategory name:', subcategory.name);
            if (newName === null) return; // User cancelled
            
            const trimmedName = newName.trim();
            if (!trimmedName) {
                alert('Subcategory name cannot be empty!');
                return;
            }
            
            // Check if new name already exists in this category (excluding current subcategory)
            if (categories[categoryIndex].subcategories.some((sub, idx) => 
                idx !== subcategoryIndex && sub.name.toLowerCase() === trimmedName.toLowerCase())) {
                alert('A subcategory with this name already exists in this category!');
                return;
            }
            
            const oldName = subcategory.name;
            
            // Update subcategory name
            categories[categoryIndex].subcategories[subcategoryIndex].name = trimmedName;
            
            // Update emoji
            const emojiInput = prompt('Edit emoji (optional):\n\nPopular choices:\nüëï T-Shirts  üëî Dress Shirts  üß• Jackets\nüëñ Jeans  üëó Dresses  üë† Heels\nüëü Sneakers  ü©≥ Shorts  üëò Traditional\nüß£ Scarves  üé© Hats  üëú Bags\nüï∂Ô∏è Sunglasses  ‚åö Watches  üíç Jewelry', subcategory.emoji || '');
            if (emojiInput !== null) {
                categories[categoryIndex].subcategories[subcategoryIndex].emoji = emojiInput.trim() || null;
            }
            
            // Update target
            const targetInput = prompt('Edit target number (leave empty for no target):', subcategory.target || '');
            if (targetInput !== null) {
                categories[categoryIndex].subcategories[subcategoryIndex].target = targetInput.trim() ? parseInt(targetInput) : null;
            }
            
            // Update all items that use this subcategory
            const items = loadItems();
            items.forEach(item => {
                if (item.category === categoryName && item.subcategory === oldName) {
                    item.subcategory = trimmedName;
                }
            });
            
            saveCategories(categories);
            saveItems(items);
            displayCategories();
            
            alert('Subcategory updated successfully!');
        }
        
        // Add subcategory
        function addSubcategoryPrompt(categoryIndex) {
            const name = prompt('Enter subcategory name:');
            if (!name) return;
            
            const emoji = prompt('Enter emoji for this subcategory (optional):\n\nPopular choices:\nüëï T-Shirts  üëî Dress Shirts  üß• Jackets\nüëñ Jeans  üëó Dresses  üë† Heels\nüëü Sneakers  ü©≥ Shorts  üëò Traditional\nüß£ Scarves  üé© Hats  üëú Bags\nüï∂Ô∏è Sunglasses  ‚åö Watches  üíç Jewelry');
            
            const target = prompt('Enter target number (optional, leave empty for no target):');
            
            const categories = loadCategories();
            
            if (categories[categoryIndex].subcategories.some(sub => sub.name.toLowerCase() === name.toLowerCase())) {
                alert('A subcategory with this name already exists!');
                return;
            }
            
            categories[categoryIndex].subcategories.push({
                name: name.trim(),
                emoji: emoji ? emoji.trim() : null,
                target: target ? parseInt(target) : null
            });
            
            saveCategories(categories);
            displayCategories();
        }
        
        // Delete category
        function deleteCategory(index) {
            const categories = loadCategories();
            if (!confirm(`Delete category "${categories[index].name}"?`)) {
                return;
            }
            categories.splice(index, 1);
            saveCategories(categories);
            displayCategories();
            updateCategorySelect();
            updateCategoryFilter();
        }
        
        // Delete subcategory
        function deleteSubcategory(categoryIndex, subcategoryIndex) {
            const categories = loadCategories();
            if (!confirm(`Delete this subcategory?`)) {
                return;
            }
            categories[categoryIndex].subcategories.splice(subcategoryIndex, 1);
            saveCategories(categories);
            displayCategories();
        }
        
        // Export data to CSV
        function exportData() {
            const items = loadItems();
            if (items.length === 0) {
                alert('No items to export!');
                return;
            }
            
            const headers = ['Name', 'Category', 'Subcategory', 'Brand', 'Color', 'Tags', 'Wear Count', 'Last Worn', 'Archived', 'Date Added'];
            const rows = items.map(item => {
                const lastWorn = item.wearHistory && item.wearHistory.length > 0 
                    ? item.wearHistory[item.wearHistory.length - 1] 
                    : '';
                
                return [
                    `"${item.name}"`,
                    `"${item.category || ''}"`,
                    `"${item.subcategory || ''}"`,
                    `"${item.brand || ''}"`,
                    `"${item.color || ''}"`,
                    `"${item.tags ? item.tags.join(';') : ''}"`,
                    item.wearCount || 0,
                    lastWorn,
                    item.archived ? 'Yes' : 'No',
                    item.dateAdded || ''
                ].join(',');
            });
            
            const csv = [headers.join(','), ...rows].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `wardrobe_export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('Data exported successfully!');
        }
        
        // Import data from CSV
        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        alert('CSV file appears to be empty!');
                        return;
                    }
                    
                    const items = loadItems();
                    let imported = 0;
                    
                    // Skip header row, process data rows
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        // Simple CSV parsing (handles quoted fields)
                        const matches = line.match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g);
                        if (!matches || matches.length < 5) continue;
                        
                        const values = matches.map(v => v.replace(/^"|"$/g, '').trim());
                        
                        const newItem = {
                            name: values[0] || 'Unnamed Item',
                            category: values[1] || 'Uncategorized',
                            subcategory: values[2] || null,
                            brand: values[3] || null,
                            color: values[4] || 'Unknown',
                            tags: values[5] ? values[5].split(';').map(t => t.trim()).filter(t => t) : [],
                            dateAdded: new Date().toISOString(),
                            wearCount: 0,
                            wearHistory: [],
                            archived: false
                        };
                        
                        items.push(newItem);
                        imported++;
                    }
                    
                    if (saveItems(items)) {
                        alert(`Successfully imported ${imported} items!`);
                        populateDataLists();
                        displayItems();
                        updateStats();
                    }
                } catch (error) {
                    console.error('Import error:', error);
                    alert('Error importing file. Please check the format.');
                }
                
                fileInput.value = '';
            };
            
            reader.readAsText(file);
        }
        
        // Clear all data
        function clearAllData() {
            if (!confirm('Are you SURE you want to delete ALL data? This cannot be undone!')) {
                return;
            }
            
            if (!confirm('This will delete all items and categories. Type YES to confirm.')) {
                return;
            }
            
            localStorage.removeItem(ITEMS_KEY);
            localStorage.removeItem(CATEGORIES_KEY);
            
            alert('All data cleared!');
            location.reload();
        }
        
        // Initialize
        setupTagInput();
        updateCategorySelect();
        updateCategoryFilter();
        updateSubcategoryFilter();
        populateDataLists();
        
        // Populate initial tag list
        if (window.availableTags) {
            const tagList = document.getElementById('tagList');
            if (tagList) {
                tagList.innerHTML = window.availableTags.map(t => `<option value="${t}">`).join('');
            }
        }
        
        displayItems();
        updateStats();
        
        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => console.log('Service Worker registered'))
                .catch(error => console.log('Service Worker registration failed:', error));
        }
    </script>
</body>
</html>
